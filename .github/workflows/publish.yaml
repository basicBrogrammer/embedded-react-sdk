name: Publish to NPM
on: workflow_dispatch
jobs:
  publish:
    runs-on:
      group: gusto-ubuntu-default
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci
      - run: npm run build
      - run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # ğŸ“š Publish documentation to ReadMe after successful npm publish
      - name: Publish documentation to ReadMe
        run: |
          echo "ğŸ“š Publishing documentation to ReadMe..."
          npm run docs:publish
        env:
          README_API_KEY: ${{ secrets.README_API_KEY }}

      # ğŸ”„ Create PR with any pending changes (like docs-lock.yml updates)
      - name: Create PR with pending changes
        if: success()
        run: |
          echo "ğŸ”„ Checking for pending changes..."

          # Check if there are any changes to commit
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "ğŸ“ Found pending changes, creating PR..."
            
            # Configure git
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            
            # Create a new branch for the changes
            BRANCH_NAME="docs-update-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            
            # Add and commit all changes
            git add .
            git commit -m "docs: update docs-lock.yml and related files after publish
            
            Auto-generated by publish workflow to sync documentation changes."
            git commit -m "docs: update docs-lock.yml and related files after publish" -m "Auto-generated by publish workflow to sync documentation changes."
            
            # Push the branch
            git push origin "$BRANCH_NAME"
            
            # Create PR using GitHub CLI
            gh pr create \
              --title "docs: sync documentation changes after publish" \
              --body "This PR contains documentation changes that were generated during the publish workflow.
              
            ## Changes
            - Updated docs-lock.yml with latest documentation structure
            - Synced any pending documentation changes
            
            This PR was automatically created by the publish workflow to ensure documentation changes are properly reviewed and merged."
            
            echo "âœ… PR created successfully: $BRANCH_NAME"
          else
            echo "âœ… No pending changes found, skipping PR creation"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
